# ORION Model Foundry - Makefile
# CrÃ©ation automatisÃ©e des modÃ¨les hybrides ORION

SHELL := /bin/bash
PYTHON := python3
MERGEKIT := /home/ubuntu/.local/bin/mergekit-yaml

# RÃ©pertoires
RECIPES_DIR := recipes
MERGED_DIR := merged_models
OUTPUT_DIR := ../public/models

# Cibles principales
.PHONY: all help install clean build-all-orion

help:
	@echo "ðŸ”¨ ORION Model Foundry - Makefile"
	@echo ""
	@echo "Commandes disponibles:"
	@echo "  make install           - Installer les dÃ©pendances"
	@echo "  make build-all-orion   - CrÃ©er les 3 modÃ¨les ORION (2-3h)"
	@echo "  make build-code-logic  - CrÃ©er ORION Code & Logic (~30-45 min)"
	@echo "  make build-creative    - CrÃ©er ORION Creative & Multilingual (~30-45 min)"
	@echo "  make build-vision      - CrÃ©er ORION Vision & Logic (~40-60 min)"
	@echo "  make clean             - Nettoyer les fichiers temporaires"
	@echo "  make clean-all         - Nettoyer tout (y compris modÃ¨les)"
	@echo ""
	@echo "Pour lancer en arriÃ¨re-plan:"
	@echo "  nohup make build-all-orion > build.log 2>&1 &"
	@echo ""
	@echo "Puis suivre la progression:"
	@echo "  tail -f build.log"

install:
	@echo "ðŸ“¦ Installation des dÃ©pendances..."
	pip3 install --user torch transformers accelerate huggingface-hub pyyaml tqdm
	pip3 install --user git+https://github.com/arcee-ai/mergekit.git
	@echo "âœ… DÃ©pendances installÃ©es!"

build-all-orion: build-code-logic build-creative build-vision
	@echo ""
	@echo "ðŸŽ‰ Les 3 modÃ¨les ORION ont Ã©tÃ© crÃ©Ã©s avec succÃ¨s!"
	@echo ""
	@echo "ModÃ¨les disponibles:"
	@ls -lh $(OUTPUT_DIR)/ORION-*/
	@echo ""
	@echo "Vous pouvez maintenant les utiliser dans ORION!"

# ORION Code & Logic v1
build-code-logic:
	@echo ""
	@echo "ðŸ”¨ [1/3] CrÃ©ation de ORION Code & Logic v1"
	@echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
	@echo "Fusion: CodeGemma 2B + Llama 3.2 3B (50/50)"
	@echo "Taille estimÃ©e: ~1.5 Go"
	@echo "Temps estimÃ©: 30-45 minutes"
	@echo ""
	
	@mkdir -p $(MERGED_DIR) $(OUTPUT_DIR)
	
	@echo "ðŸ“¥ Ã‰tape 1/3: Fusion des modÃ¨les avec SLERP..."
	@$(MERGEKIT) $(RECIPES_DIR)/orion-code-logic-v1.yml \
		$(MERGED_DIR)/ORION-Code-Logic-v1 \
		--copy-tokenizer \
		--allow-crimes \
		--verbose || (echo "âŒ Erreur lors de la fusion"; exit 1)
	
	@echo "âœ… Fusion terminÃ©e!"
	@echo ""
	@echo "ðŸ”§ Ã‰tape 2/3: Quantification q4..."
	@$(PYTHON) optimize_pipeline.py \
		--model_path $(MERGED_DIR)/ORION-Code-Logic-v1 \
		--output_path $(OUTPUT_DIR)/ORION-Code-Logic-v1-q4 \
		--quantization q4 \
		--shard_size 150 || (echo "âŒ Erreur lors de la quantification"; exit 1)
	
	@echo "âœ… Quantification terminÃ©e!"
	@echo ""
	@echo "ðŸ“¦ Ã‰tape 3/3: VÃ©rification..."
	@ls -lh $(OUTPUT_DIR)/ORION-Code-Logic-v1-q4/
	@echo ""
	@echo "âœ… ORION Code & Logic v1 crÃ©Ã© avec succÃ¨s!"
	@echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# ORION Creative & Multilingual v1
build-creative:
	@echo ""
	@echo "ðŸ”¨ [2/3] CrÃ©ation de ORION Creative & Multilingual v1"
	@echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
	@echo "Fusion: Mistral 7B + Qwen2 1.5B (70/30)"
	@echo "Taille estimÃ©e: ~2.6 Go"
	@echo "Temps estimÃ©: 30-45 minutes"
	@echo ""
	
	@mkdir -p $(MERGED_DIR) $(OUTPUT_DIR)
	
	@echo "ðŸ“¥ Ã‰tape 1/3: Fusion des modÃ¨les avec SLERP..."
	@$(MERGEKIT) $(RECIPES_DIR)/orion-creative-multilingual-v1.yml \
		$(MERGED_DIR)/ORION-Creative-Multilingual-v1 \
		--copy-tokenizer \
		--allow-crimes \
		--verbose || (echo "âŒ Erreur lors de la fusion"; exit 1)
	
	@echo "âœ… Fusion terminÃ©e!"
	@echo ""
	@echo "ðŸ”§ Ã‰tape 2/3: Quantification q4..."
	@$(PYTHON) optimize_pipeline.py \
		--model_path $(MERGED_DIR)/ORION-Creative-Multilingual-v1 \
		--output_path $(OUTPUT_DIR)/ORION-Creative-Multilingual-v1-q4 \
		--quantization q4 \
		--shard_size 200 || (echo "âŒ Erreur lors de la quantification"; exit 1)
	
	@echo "âœ… Quantification terminÃ©e!"
	@echo ""
	@echo "ðŸ“¦ Ã‰tape 3/3: VÃ©rification..."
	@ls -lh $(OUTPUT_DIR)/ORION-Creative-Multilingual-v1-q4/
	@echo ""
	@echo "âœ… ORION Creative & Multilingual v1 crÃ©Ã© avec succÃ¨s!"
	@echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# ORION Vision & Logic v1
build-vision:
	@echo ""
	@echo "ðŸ”¨ [3/3] CrÃ©ation de ORION Vision & Logic v1"
	@echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
	@echo "Fusion: LLaVA 1.5 (LLM) + Llama 3.2 3B (60/40)"
	@echo "Taille estimÃ©e: ~3.4 Go"
	@echo "Temps estimÃ©: 40-60 minutes"
	@echo ""
	
	@mkdir -p $(MERGED_DIR) $(OUTPUT_DIR)
	
	@echo "ðŸ“¥ Ã‰tape 1/3: Fusion des modÃ¨les avec SLERP..."
	@$(MERGEKIT) $(RECIPES_DIR)/orion-vision-logic-v1.yml \
		$(MERGED_DIR)/ORION-Vision-Logic-v1 \
		--copy-tokenizer \
		--allow-crimes \
		--verbose || (echo "âŒ Erreur lors de la fusion"; exit 1)
	
	@echo "âœ… Fusion terminÃ©e!"
	@echo ""
	@echo "ðŸ”§ Ã‰tape 2/3: Quantification q4..."
	@$(PYTHON) optimize_pipeline.py \
		--model_path $(MERGED_DIR)/ORION-Vision-Logic-v1 \
		--output_path $(OUTPUT_DIR)/ORION-Vision-Logic-v1-q4 \
		--quantization q4 \
		--shard_size 200 || (echo "âŒ Erreur lors de la quantification"; exit 1)
	
	@echo "âœ… Quantification terminÃ©e!"
	@echo ""
	@echo "ðŸ“¦ Ã‰tape 3/3: VÃ©rification..."
	@ls -lh $(OUTPUT_DIR)/ORION-Vision-Logic-v1-q4/
	@echo ""
	@echo "âœ… ORION Vision & Logic v1 crÃ©Ã© avec succÃ¨s!"
	@echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# Nettoyage
clean:
	@echo "ðŸ§¹ Nettoyage des fichiers temporaires..."
	@rm -rf __pycache__ *.pyc .pytest_cache
	@echo "âœ… Nettoyage terminÃ©!"

clean-merged:
	@echo "ðŸ§¹ Suppression des modÃ¨les fusionnÃ©s (intermÃ©diaires)..."
	@rm -rf $(MERGED_DIR)/*
	@echo "âœ… ModÃ¨les fusionnÃ©s supprimÃ©s!"

clean-all: clean clean-merged
	@echo "ðŸ§¹ Suppression de tous les modÃ¨les gÃ©nÃ©rÃ©s..."
	@rm -rf $(OUTPUT_DIR)/ORION-*
	@echo "âš ï¸  Tous les modÃ¨les ORION ont Ã©tÃ© supprimÃ©s!"

# Informations
info:
	@echo "ðŸ“Š Ã‰tat de la Model Foundry"
	@echo ""
	@echo "Recettes disponibles:"
	@ls -1 $(RECIPES_DIR)/*.yml
	@echo ""
	@echo "ModÃ¨les fusionnÃ©s:"
	@ls -1d $(MERGED_DIR)/* 2>/dev/null || echo "Aucun"
	@echo ""
	@echo "ModÃ¨les optimisÃ©s:"
	@ls -1d $(OUTPUT_DIR)/ORION-* 2>/dev/null || echo "Aucun"
	@echo ""
	@echo "Espace disque:"
	@df -h /workspace | grep -v Filesystem

.DEFAULT_GOAL := help
